
Name of Test - PCIe enumeration repetive test with Power On and Off to chip
===============================================================================

First time: -
---------------
cd /sys/class/gpio
echo 117 > export
cd gpio117
echo out > direction


To repeat: -
---------------
echo 1 > value

echo 1 > /sys/devices/platform/161c0000.pcie/pcie_sysfs
echo 1 > /sys/devices/platform/161c1000.pcie/pcie_sysfs

cd /data/misc/wifi
./lspci | grep -i 12be
# Expected o/p -
##0000:01:00.0 Class 0280: Device 12be:bd31 (rev 01)
##0001:01:00.0 Class 0280: Device 12be:bd31 (rev 01)

#At this point link should be UP
echo 3 > /sys/devices/platform/161c0000.pcie/pcie_sysfs  
echo 3 > /sys/devices/platform/161c1000.pcie/pcie_sysfs

#Expected o/p on " dmesg -w | grep -i -e pcie -e dhd -e MIR"
## Appearnce of string  - "Current Link Speed is GEN1 (MAX GEN3)"

cd /sys/class/gpio/gpio117
echo 0 > value

#Expected o/p on " dmesg -w | grep -i -e pcie -e dhd -e MIR"
## 1420.233185] exynos-v920-pcie 161c1000.pcie: pcie link up fail

echo 1 > /sys/devices/platform/161c0000.pcie/pcie_sysfs
echo 1 > /sys/devices/platform/161c1000.pcie/pcie_sysfs

#Expected o/p enum shoUuld fail and dmesg o/p - appearance of this string - "exynos_v920_pcie_poweroff"
#If enumeration fails then above "echo 1 " command takes longer time to execute due to retry, it is trick
# (but not actual) to find enumeration failue.


##Number of trials done: 
## 3+1+1+1 
(Panic occured two times by making output - 0 to GPIO 117.) 

Result: - If we do power Off in between, then it is generating Panic after some random number of iterations.




Name of Test - PCIe enumeration repetive test with Power On and Off to chip + Wifi Driver loading on both channels 
=====================================================================================================================
Note -  "echo 2 " command writes 0 to GPIO- wifi_reg_on.
		"echo 10" means LTSSM disable.

First time: -
---------------
cd /sys/class/gpio
echo 117 > export
cd gpio117
echo out > direction


To repeat: -
---------------
# Power ON the Wifi Chip
echo 1 > /sys/class/gpio/gpio117/value

echo 1 > /sys/devices/platform/161c1000.pcie/pcie_sysfs
echo 1 > /sys/devices/platform/161c0000.pcie/pcie_sysfs

cd /data/misc/wifi
./lspci | grep -i 12be
# Expected o/p -
##0000:01:00.0 Class 0280: Device 12be:bd31 (rev 01)
##0001:01:00.0 Class 0280: Device 12be:bd31 (rev 01)

#At this point link should be UP
echo 3 > /sys/devices/platform/161c0000.pcie/pcie_sysfs  
echo 3 > /sys/devices/platform/161c1000.pcie/pcie_sysfs

#Expected o/p on " dmesg -w | grep -i -e pcie -e dhd -e MIR"
## Appearnce of string  - "Current Link Speed is GEN1 (MAX GEN3)"

#WLAN 2 driver loading => MASTER
cd /vendor/lib/modules/
insmod bcmdhd.ko firmware_path=/data/misc/wifi/fw.trxse nvram_path=/lib/firmware/bcmdhd.cal clm_path=/data/misc/wifi/55560a1.clm_blob pcie_dev_bus_name='"PCI Bus 0001:01"' dhd_msg_level=0xffff
lsmod | grep bcmdhd

rmmod bcmdhd

#WLAN 1 driver loading => SLAVE

insmod bcmdhd.ko firmware_path=/data/misc/wifi/fw.trxse nvram_path=/lib/firmware/bcmdhd.cal clm_path=/data/misc/wifi/55560a1.clm_blob pcie_dev_bus_name='"PCI Bus 0000:01"' dhd_msg_level=0xffff
lsmod | grep bcmdhd

rmmod bcmdhd









echo 2 > /sys/devices/platform/161c0000.pcie/pcie_sysfs
echo 2 > /sys/devices/platform/161c1000.pcie/pcie_sysfs

cd /sys/class/gpio/gpio117
echo 0 > value

#Expected o/p on " dmesg -w | grep -i -e pcie -e dhd -e MIR"
## 1420.233185] exynos-v920-pcie 161c1000.pcie: pcie link up fail

#Expected o/p enum shold fail and dmesg o/p - appearance of this string - "exynos_v920_pcie_poweroff"
#If enumeration fails then above "echo 1 " command takes longer time to execute due to retry, it is trick
# (but not actual) to find enumeration failue.


##Number of trials done: 
## 1+1+

##Result - 
-----------
If after doing insmod then rmmod and again insmod, then in next iteration insmod is not working.
O/p - 
 cd /vendor/lib/modules/
lm_blob pcie_dev_bus_name='"PCI Bus 0001:01"' dhd_msg_level=0xffff            <
insmod: failed to load bcmdhd.ko: Operation not permitted
1|console:/vendor/lib/modules # lsmod | grep bcmdhd

Dmesg log: -
----------------
[  269.238418] dhd_module_init in
[  269.238567] dhd_bus_register: Enter
[  269.238686] dhdpcie_chipmatch: Supporting vendor 12be device bd31
[  269.238698] pcieh: PCI_PROBE: bus 1, slot 0,vendor 12BE, device BD31(good PCI location), name PCI Bus 0000:01
[  269.238706] pcieh: PCI_PROBE: bus name (PCI Bus 0000:01) matched (PCI Bus 0000:01)
[  269.238712] dhdpcie_init: can't find adapter info for this chip
[  269.238719] dhdpcie_scan_resource: ENTER
[  269.238750] pcieh 0000:01:00.0: enabling device (0000 -> 0002)
[  269.239244] dhdpcie_get_resource:Phys addr : reg space = 000000004ec2993d base addr 0x0x0000000060800000
[  269.239252] dhdpcie_get_resource:Phys addr : tcm_space = 00000000454e5371 base addr 0x0x0000000060000000
[  269.239258] dhdpcie_scan_resource:Exit - SUCCESS
[  269.239263] dhdpcie_bus_attach: ENTER
[  269.239269] dhdpcie_dongle_attach: ENTER
[  269.239322] dhdpcie_dongle_attach: before read reg_val:0
[  269.239330] dhdpcie_dongle_attach: after reg_val:-1
[  269.239368] dhdpcie_dongle_attach: si_attach failed!
[  269.239373] dhdpcie_dongle_attach: EXIT: FAILURE
[  269.239377] dhdpcie_bus_attach: dhdpcie_probe_attach failed
[  269.239382] dhdpcie_bus_attach: EXIT FAILURE
[  269.239386] dhdpcie_init:dhdpcie_bus_attach() failed
[  269.239406] dhdpcie_init:Exit - FAILURE
[  269.239411] dhdpcie_pci_probe: PCIe Enumeration failed
[  269.239484] dhdpcie_chipmatch: Supporting vendor 12be device bd31
[  269.239490] pcieh: PCI_PROBE: bus 1, slot 0,vendor 12BE, device BD31(good PCI location), name PCI Bus 0001:01
[  269.239496] pcieh: PCI_PROBE: bus name (PCI Bus 0000:01) did not match (PCI Bus 0001:01)
[  269.240557] dhdpcie_bus_register: dhdpcie initialize failed.
[  269.240870] dhd_module_init: Failed to load the driver, try cnt 0
[  269.240927] dhd_module_init: Failed to load driver max retry reached**
[  269.240932] dhd_module_init out
[  269.260728] debug-snapshot dss: Module bcmdhd, Going - 0xffffffc0025d7000
[  348.648636] debug-snapshot dss: Module bcmdhd, Coming - 0xffffffc0025d7000
[  348.648976] dhd_module_init in
[  348.649127] dhd_bus_register: Enter
[  348.649243] dhdpcie_chipmatch: Supporting vendor 12be device bd31
[  348.649252] pcieh: PCI_PROBE: bus 1, slot 0,vendor 12BE, device BD31(good PCI location), name PCI Bus 0000:01
[  348.649259] pcieh: PCI_PROBE: bus name (PCI Bus 0001:01) did not match (PCI Bus 0000:01)
[  348.649326] dhdpcie_chipmatch: Supporting vendor 12be device bd31
[  348.649333] pcieh: PCI_PROBE: bus 1, slot 0,vendor 12BE, device BD31(good PCI location), name PCI Bus 0001:01
[  348.649339] pcieh: PCI_PROBE: bus name (PCI Bus 0001:01) matched (PCI Bus 0001:01)
[  348.649345] dhdpcie_init: can't find adapter info for this chip
[  348.649351] dhdpcie_scan_resource: ENTER
[  348.649384] pcieh 0001:01:00.0: enabling device (0000 -> 0002)
[  348.649914] dhdpcie_get_resource:Phys addr : reg space = 0000000060a6008a base addr 0x0x0000000070800000
[  348.649922] dhdpcie_get_resource:Phys addr : tcm_space = 00000000126c9e6c base addr 0x0x0000000070000000
[  348.649928] dhdpcie_scan_resource:Exit - SUCCESS
[  348.649933] dhdpcie_bus_attach: ENTER
[  348.649939] dhdpcie_dongle_attach: ENTER
[  348.649995] dhdpcie_dongle_attach: before read reg_val:0
[  348.650003] dhdpcie_dongle_attach: after reg_val:-1
[  348.650043] dhdpcie_dongle_attach: si_attach failed!
[  348.650048] dhdpcie_dongle_attach: EXIT: FAILURE
[  348.650053] dhdpcie_bus_attach: dhdpcie_probe_attach failed
[  348.650057] dhdpcie_bus_attach: EXIT FAILURE
[  348.650062] dhdpcie_init:dhdpcie_bus_attach() failed
[  348.650081] dhdpcie_init:Exit - FAILURE
[  348.650087] dhdpcie_pci_probe: PCIe Enumeration failed
[  348.651051] dhdpcie_bus_register: dhdpcie initialize failed.
[  348.651178] dhd_module_init: Failed to load the driver, try cnt 0
[  348.651222] dhd_module_init: Failed to load driver max retry reached**
[  348.651227] dhd_module_init out
[  348.668741] debug-snapshot dss: Module bcmdhd, Going - 0xffffffc0025d7000

Result2: -
============
If I do "echo 1" after "echo 2", then Panic is happening.